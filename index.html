<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ricettario Web App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="favicon.ico">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=Inter:wght@400;500;600&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #fef3e2 0%, #fae8d0 100%);
        }
        
        h1, h2, h3 {
            font-family: 'Playfair Display', serif;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(217, 119, 6, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(194, 65, 12, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            position: relative;
            z-index: 1;
        }
        
        .paper-texture {
            background: linear-gradient(180deg, #fffbf5 0%, #fff9f0 100%);
            box-shadow: 0 4px 6px rgba(120, 53, 15, 0.08), 0 2px 4px rgba(120, 53, 15, 0.06);
        }
        
        .corner-decoration::before,
        .corner-decoration::after {
            content: '‚ú¶';
            position: absolute;
            color: #d97706;
            font-size: 1.25rem;
            opacity: 0.3;
        }
        
        .corner-decoration::before {
            top: 0.75rem;
            left: 0.75rem;
        }
        
        .corner-decoration::after {
            top: 0.75rem;
            right: 0.75rem;
        }

        .print-mode #recipe-view-header,
        .print-mode #scaling-controls {
            display: none;
        }
        
        .print-mode #recipe-view {
            box-shadow: none;
            border: none;
            margin-top: 0;
            padding-top: 0;
        }
        
        select.unit-select[data-unit="qb"] ~ input.amount-input {
            visibility: hidden;
        }

        #notification {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            transform: translateY(100%);
            opacity: 0;
        }
        
        #notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .icon-sm {
            width: 1.25rem;
            height: 1.25rem;
        }
        .icon-xs {
            width: 1rem;
            height: 1rem;
        }
        
        .btn-recipe {
            position: relative;
            transition: all 0.2s ease;
        }
        
        .btn-recipe:hover {
            transform: translateY(-1px);
        }
        
        .recipe-tag {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #f59e0b;
            transition: all 0.2s ease;
        }
        
        .recipe-tag:hover {
            background: linear-gradient(135deg, #fde68a 0%, #fbbf24 100%);
            transform: scale(1.05);
        }
        
        .divider-decorative {
            height: 2px;
            background: linear-gradient(to right, transparent, #d97706, transparent);
            position: relative;
        }
        
        .divider-decorative::after {
            content: '‚ù¶';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: #fffbf5;
            padding: 0 1rem;
            color: #d97706;
            font-size: 1.5rem;
        }
    </style>
</head>

<body class="min-h-screen">
    <div class="container max-w-6xl mx-auto p-4 md:p-8">
        <header class="text-center mb-8 md:mb-12 relative">
            <div class="inline-block relative">
                <h1 class="text-5xl md:text-6xl font-bold text-amber-900 mb-2 tracking-tight">Il mio Ricettario</h1>
                <div class="divider-decorative mt-4"></div>
            </div>
            <p class="text-amber-800/70 mt-4 text-lg italic">Raccolte di sapori e tradizioni</p>
        </header>

        <main id="db-manager-view">
            <div class="paper-texture corner-decoration p-6 md:p-8 rounded-2xl border-2 border-amber-200/50 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-amber-100/20 to-transparent rounded-full -mr-16 -mt-16"></div>
                
                <h2 class="text-3xl font-bold mb-6 text-amber-900 relative">Le mie Ricette</h2>
                
                <div class="flex flex-col md:flex-row gap-3 mb-6">
                    <div class="flex-grow relative">
                        <input type="search" id="search-input" placeholder="Cerca tra le ricette..." class="w-full border-2 border-amber-200 rounded-xl px-5 py-3.5 pl-12 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500 bg-white/80 backdrop-blur-sm transition-all">
                        <svg class="icon-sm absolute left-4 top-1/2 -translate-y-1/2 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <button id="add-recipe-btn" class="btn-recipe w-full md:w-auto bg-gradient-to-r from-amber-600 to-amber-700 text-white px-6 py-3.5 rounded-xl font-semibold hover:from-amber-700 hover:to-amber-800 shadow-lg shadow-amber-900/20 flex items-center justify-center gap-2">
                        <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        <span>Nuova Ricetta</span>
                    </button>
                </div>

                <div class="flex flex-col sm:flex-row gap-2 mb-6 p-4 bg-amber-50/50 rounded-xl border border-amber-200/50">
                    <button id="load-db-btn" class="flex-1 bg-white border-2 border-amber-300 text-amber-900 px-4 py-2.5 rounded-lg font-medium hover:bg-amber-50 transition-all text-sm shadow-sm">
                        üì• Carica da db.json
                    </button>
                    <button id="save-github-btn" class="flex-1 bg-white border-2 border-amber-300 text-amber-900 px-4 py-2.5 rounded-lg font-medium hover:bg-amber-50 transition-all text-sm shadow-sm">
                        üì§ Salva su GitHub
                    </button>
                    <button id="export-json-btn" class="flex-1 bg-white border-2 border-amber-300 text-amber-900 px-4 py-2.5 rounded-lg font-medium hover:bg-amber-50 transition-all text-sm shadow-sm">
                        üíæ Esporta JSON
                    </button>
                    <button id="reset-filters-btn" class="flex-1 bg-white border-2 border-rose-300 text-rose-900 px-4 py-2.5 rounded-lg font-medium hover:bg-rose-50 transition-all text-sm shadow-sm hidden">
                        üîÑ Reset Filtri
                    </button>
                </div>

                <div id="recipe-list-container" class="space-y-4">
                    <p class="text-amber-700/60 text-center py-8 italic">Caricamento ricette...</p>
                </div>
            </div>
        </main>

        <section id="recipe-view" class="hidden">
            <div id="recipe-view-header" class="flex justify-between items-center mb-6">
                <button id="back-to-list-btn" class="btn-recipe bg-white border-2 border-amber-300 text-amber-900 px-5 py-3 rounded-xl font-semibold hover:bg-amber-50 shadow-md flex items-center gap-2">
                    <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    <span>Torna alla Lista</span>
                </button>
                <button id="print-view-btn" class="btn-recipe bg-white border-2 border-amber-300 text-amber-900 px-5 py-3 rounded-xl font-semibold hover:bg-amber-50 shadow-md flex items-center gap-2">
                    <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                    <span>Vista Pulita</span>
                </button>
            </div>

            <div class="paper-texture corner-decoration p-6 md:p-10 rounded-2xl border-2 border-amber-200/50 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-40 h-40 bg-gradient-to-br from-orange-100/20 to-transparent rounded-full -ml-20 -mt-20"></div>
                
                <h2 id="recipe-view-name" class="text-4xl md:text-5xl font-bold text-amber-900 mb-6 relative"></h2>
                
                <div class="relative mb-8">
                    <img id="recipe-view-image" src="" alt="Immagine ricetta" class="w-full h-56 md:h-96 object-cover rounded-xl border-4 border-white shadow-xl">
                    <div class="absolute inset-0 rounded-xl shadow-inner pointer-events-none"></div>
                </div>
                
                <p class="text-lg text-amber-800/80 mb-6 italic text-center bg-amber-50/50 py-3 px-6 rounded-lg border border-amber-200/50">
                    üçΩÔ∏è Dosi originali per: <strong class="text-amber-900 font-semibold" id="recipe-view-servings-original"></strong>
                </p>

                <div id="scaling-controls" class="bg-gradient-to-br from-orange-50 to-amber-50 p-6 rounded-xl border-2 border-orange-200/60 mb-8 shadow-sm">
                    <h3 class="text-xl font-bold text-orange-900 mb-4 flex items-center gap-2">
                        <span>‚öñÔ∏è</span>
                        <span>Ricalcola le Dosi</span>
                    </h3>
                    <div class="flex flex-col md:flex-row gap-3">
                        <input type="text" id="recipe-servings-input" placeholder="Es: 8 porzioni o 24 cm" class="flex-grow w-full border-2 border-orange-300 rounded-lg px-5 py-3.5 focus:outline-none focus:ring-2 focus:ring-orange-500 bg-white">
                        <button id="scale-recipe-btn" class="btn-recipe w-full md:w-auto bg-gradient-to-r from-orange-600 to-orange-700 text-white px-6 py-3.5 rounded-lg font-semibold hover:from-orange-700 hover:to-orange-800 shadow-lg shadow-orange-900/20">
                            Ricalcola
                        </button>
                    </div>
                </div>

                <div class="divider-decorative my-8"></div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1">
                        <div class="bg-amber-50/50 p-6 rounded-xl border-2 border-amber-200/50">
                            <h3 class="text-2xl font-bold text-amber-900 mb-4 flex items-center gap-2">
                                <span>ü•ï</span>
                                <span>Ingredienti</span>
                            </h3>
                            <ul id="recipe-view-ingredients" class="space-y-3 list-none text-amber-900"></ul>
                        </div>
                    </div>
                    
                    <div class="lg:col-span-2">
                        <div class="bg-orange-50/30 p-6 rounded-xl border-2 border-orange-200/50">
                            <h3 class="text-2xl font-bold text-amber-900 mb-4 flex items-center gap-2">
                                <span>üë®‚Äçüç≥</span>
                                <span>Procedimento</span>
                            </h3>
                            <div id="recipe-view-procedure" class="prose prose-lg text-amber-900/90 whitespace-pre-line leading-relaxed"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="recipe-form-view" class="hidden">
            <div class="paper-texture corner-decoration p-6 md:p-10 rounded-2xl border-2 border-amber-200/50 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-40 h-40 bg-gradient-to-br from-amber-100/20 to-transparent rounded-full -mr-20 -mt-20"></div>
                
                <h2 id="form-title" class="text-3xl font-bold mb-8 text-amber-900 relative flex items-center gap-3">
                    <span>üìù</span>
                    <span>Nuova Ricetta</span>
                </h2>
                
                <form id="recipe-form" class="space-y-6">
                    <input type="hidden" id="recipe-id">
                    
                    <div>
                        <label for="recipe-name" class="block text-base font-semibold text-amber-900 mb-2">Nome della Ricetta</label>
                        <input type="text" id="recipe-name" class="w-full border-2 border-amber-200 rounded-xl px-5 py-3.5 focus:outline-none focus:ring-2 focus:ring-amber-500 bg-white/80 backdrop-blur-sm" required>
                    </div>
                    
                    <div>
                        <label for="recipe-servings" class="block text-base font-semibold text-amber-900 mb-2">Porzioni / Teglia (Default: 20 cm)</label>
                        <input type="text" id="recipe-servings" placeholder="Es: 8 porzioni, 24 cm" class="w-full border-2 border-amber-200 rounded-xl px-5 py-3.5 focus:outline-none focus:ring-2 focus:ring-amber-500 bg-white/80 backdrop-blur-sm" required>
                    </div>
                    
                    <div>
                        <label for="recipe-image" class="block text-base font-semibold text-amber-900 mb-2">URL Immagine</label>
                        <input type="text" id="recipe-image" placeholder="Es: img/mia-torta.png" class="w-full border-2 border-amber-200 rounded-xl px-5 py-3.5 focus:outline-none focus:ring-2 focus:ring-amber-500 bg-white/80 backdrop-blur-sm">
                    </div>

                    <div class="bg-amber-50/50 p-6 rounded-xl border-2 border-amber-200/50">
                        <h3 class="text-xl font-bold text-amber-900 mb-4 flex items-center gap-2">
                            <span>ü•ï</span>
                            <span>Ingredienti</span>
                        </h3>
                        <div id="ingredients-list" class="space-y-3 mb-4"></div>
                        <button type="button" id="add-ingredient-btn" class="bg-white border-2 border-amber-300 text-amber-900 px-5 py-2.5 rounded-lg font-semibold hover:bg-amber-50 transition-all text-sm shadow-sm">
                            ‚ûï Aggiungi Ingrediente
                        </button>
                    </div>
                    
                    <div>
                        <label for="recipe-procedure" class="block text-base font-semibold text-amber-900 mb-2 flex items-center gap-2">
                            <span>üë®‚Äçüç≥</span>
                            <span>Procedimento</span>
                        </label>
                        <textarea id="recipe-procedure" rows="12" class="w-full border-2 border-amber-200 rounded-xl px-5 py-3.5 focus:outline-none focus:ring-2 focus:ring-amber-500 bg-white/80 backdrop-blur-sm font-normal" required></textarea>
                    </div>
                    
                    <div>
                        <label for="recipe-tags" class="block text-base font-semibold text-amber-900 mb-2 flex items-center gap-2">
                            <span>üè∑Ô∏è</span>
                            <span>Tag (separati da virgola)</span>
                        </label>
                        <input type="text" id="recipe-tags" placeholder="Es: dolci, colazione, facile" class="w-full border-2 border-amber-200 rounded-xl px-5 py-3.5 focus:outline-none focus:ring-2 focus:ring-amber-500 bg-white/80 backdrop-blur-sm">
                    </div>
                    
                    <div class="flex gap-4 pt-6 border-t-2 border-amber-200">
                        <button type="button" id="cancel-form-btn" class="btn-recipe flex-1 bg-white border-2 border-amber-300 text-amber-900 px-6 py-4 rounded-xl font-semibold hover:bg-amber-50 shadow-md">
                            Annulla
                        </button>
                        <button type="submit" id="save-form-btn" class="btn-recipe flex-1 bg-gradient-to-r from-amber-600 to-amber-700 text-white px-6 py-4 rounded-xl font-semibold hover:from-amber-700 hover:to-amber-800 shadow-lg shadow-amber-900/20">
                            üíæ Salva Ricetta
                        </button>
                    </div>
                </form>
            </div>
        </section>
    </div>

    <div id="notification" class="fixed bottom-6 right-6 bg-gradient-to-r from-amber-900 to-amber-800 text-white px-6 py-4 rounded-xl shadow-2xl border-2 border-amber-700 font-medium">
        Messaggio di notifica
    </div>

    <script>
        const app = {
            recipes: [],
            currentView: 'list',
            currentRecipeId: null,
            activeTag: null,
            searchTerm: '',
            dbUrl: 'https://raw.githubusercontent.com/fabiusai/ricettario/main/db.json',
            githubUrl: 'https://github.com/fabiusai/ricettario/blob/main/db.json',
            defaultImg: 'https://raw.githubusercontent.com/fabiusai/ricettario/main/img/ricetta.png',

            ui: {
                views: {
                    list: document.getElementById('db-manager-view'),
                    view: document.getElementById('recipe-view'),
                    form: document.getElementById('recipe-form-view'),
                },
                recipeListContainer: document.getElementById('recipe-list-container'),
                searchInput: document.getElementById('search-input'),
                resetFiltersBtn: document.getElementById('reset-filters-btn'),
                notification: document.getElementById('notification'),
            },

            init() {
                this.getRecipesFromLocal();
                if (this.recipes.length === 0) {
                    this.fetchRecipes(document.getElementById('load-db-btn'));
                } else {
                    this.renderRecipeList();
                }

                document.getElementById('add-recipe-btn').addEventListener('click', () => this.renderRecipeForm(null));
                document.getElementById('load-db-btn').addEventListener('click', (e) => this.fetchRecipes(e.currentTarget));
                document.getElementById('save-github-btn').addEventListener('click', (e) => this.handleSaveToGitHub(e.currentTarget));
                document.getElementById('export-json-btn').addEventListener('click', (e) => this.handleExportJson(e.currentTarget));
                this.ui.searchInput.addEventListener('input', (e) => this.handleSearch(e));
                this.ui.resetFiltersBtn.addEventListener('click', () => this.resetFilters());
                this.ui.recipeListContainer.addEventListener('click', (e) => this.handleRecipeListClick(e));
                document.getElementById('back-to-list-btn').addEventListener('click', () => this.showView('list'));
                document.getElementById('scale-recipe-btn').addEventListener('click', (e) => this.handleScaleRecipe(e.currentTarget));
                document.getElementById('print-view-btn').addEventListener('click', (e) => this.handlePrintView(e.currentTarget));
                document.getElementById('recipe-form').addEventListener('submit', (e) => this.handleFormSubmit(e));
                document.getElementById('cancel-form-btn').addEventListener('click', () => this.showView('list'));
                document.getElementById('add-ingredient-btn').addEventListener('click', () => this.addIngredientRow());
                document.getElementById('ingredients-list').addEventListener('click', (e) => this.handleIngredientFormClick(e));
            },

            showView(viewName) {
                this.currentView = viewName;
                Object.values(this.ui.views).forEach(view => view.classList.add('hidden'));
                if (this.ui.views[viewName]) {
                    this.ui.views[viewName].classList.remove('hidden');
                }
                window.scrollTo(0, 0);
                document.body.classList.remove('print-mode');
                document.getElementById('print-view-btn').innerHTML = `
                    <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                    <span>Vista Pulita</span>`;
            },

            saveRecipesToLocal() {
                localStorage.setItem('ricettarioDB', JSON.stringify(this.recipes));
            },

            getRecipesFromLocal() {
                try {
                    this.recipes = JSON.parse(localStorage.getItem('ricettarioDB') || '[]');
                } catch (e) {
                    console.error("Errore parsing localStorage:", e);
                    this.recipes = [];
                }
            },

            async fetchRecipes(button) {
                if (button) this.showButtonFeedback(button, 'Caricamento...', 99999);
                try {
                    const response = await fetch(`${this.dbUrl}?t=${new Date().getTime()}`, {
                        cache: 'no-store'
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    this.recipes = Array.isArray(data) ? data : [];
                    this.saveRecipesToLocal();
                    this.renderRecipeList();
                    if (button) this.showButtonFeedback(button, 'Fatto!', 1500, true);
                    this.showNotification('Database caricato da db.json');
                } catch (error) {
                    console.error('Errore caricamento db.json:', error);
                    if (button) this.showButtonFeedback(button, 'Errore!', 2000, true);
                    this.showNotification('Errore caricamento db.json', true);
                }
            },

            handleSaveToGitHub(button) {
                try {
                    const dbJson = JSON.stringify(this.recipes, null, 2);
                    const textarea = document.createElement('textarea');
                    textarea.value = dbJson;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = 0;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    this.showButtonFeedback(button, 'Copiato!', 2000);
                    this.showNotification('DB Copiato! Ora incollalo su GitHub.');
                    window.open(this.githubUrl, '_blank');
                } catch (e) {
                    console.error("Errore copia clipboard:", e);
                    this.showButtonFeedback(button, 'Errore!', 2000, true);
                    this.showNotification('Errore durante la copia.', true);
                }
            },
            
            handleExportJson(button) {
                this.showButtonFeedback(button, 'Esporto...', 99999);
                try {
                    const dbJson = JSON.stringify(this.recipes, null, 2);
                    const blob = new Blob([dbJson], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'db.json';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    this.showButtonFeedback(button, 'Esportato!', 1500, true);
                } catch (e) {
                    console.error("Errore esportazione JSON:", e);
                    this.showButtonFeedback(button, 'Errore!', 2000, true);
                    this.showNotification('Errore durante l\'esportazione.', true);
                }
            },

            renderRecipeList() {
                this.ui.recipeListContainer.innerHTML = '';
                
                const filteredRecipes = this.recipes.filter(recipe => {
                    const matchesTag = !this.activeTag || (recipe.tags && recipe.tags.toLowerCase().split(',').map(t => t.trim()).includes(this.activeTag));
                    const term = this.searchTerm.toLowerCase();
                    const matchesSearch = !term || (
                        recipe.name.toLowerCase().includes(term) ||
                        (recipe.procedure && recipe.procedure.toLowerCase().includes(term)) ||
                        (recipe.tags && recipe.tags.toLowerCase().includes(term)) ||
                        (recipe.ingredients && recipe.ingredients.some(i => i.name.toLowerCase().includes(term)))
                    );
                    return matchesTag && matchesSearch;
                });

                if (this.activeTag || this.searchTerm) {
                    this.ui.resetFiltersBtn.classList.remove('hidden');
                } else {
                    this.ui.resetFiltersBtn.classList.add('hidden');
                }

                if (filteredRecipes.length === 0) {
                    this.ui.recipeListContainer.innerHTML = `<p class="text-amber-700/60 text-center py-8 italic">Nessuna ricetta trovata.</p>`;
                    return;
                }

                filteredRecipes.forEach(recipe => {
                    const tagsHtml = (recipe.tags || '')
                        .split(',')
                        .filter(tag => tag.trim() !== '')
                        .map(tag => `
                            <button class="tag-btn recipe-tag rounded-full px-3 py-1.5 text-sm font-semibold" data-tag="${tag.trim().toLowerCase()}">
                                ${tag.trim()}
                            </button>
                        `).join(' ');

                    const recipeEl = document.createElement('div');
                    recipeEl.className = 'paper-texture p-5 rounded-xl border-2 border-amber-200/50 flex flex-col md:flex-row md:justify-between md:items-center gap-4 hover:shadow-lg transition-all duration-200';
                    recipeEl.innerHTML = `
                        <div class="flex-grow">
                            <h3 class="text-2xl font-bold text-amber-900 mb-3">${recipe.name}</h3>
                            <div class="flex flex-wrap gap-2">
                                ${tagsHtml}
                            </div>
                        </div>
                        <div class="flex-shrink-0 flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                            <button data-action="view" data-id="${recipe.id}" class="btn-recipe w-full sm:w-auto bg-gradient-to-r from-amber-600 to-amber-700 text-white px-5 py-3 rounded-xl font-semibold hover:from-amber-700 hover:to-amber-800 shadow-md flex items-center justify-center gap-2 text-sm">
                                <svg class="icon-xs" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                Visualizza
                            </button>
                            <button data-action="edit" data-id="${recipe.id}" class="btn-recipe w-full sm:w-auto bg-white border-2 border-amber-300 text-amber-900 px-5 py-3 rounded-xl font-semibold hover:bg-amber-50 shadow-md flex items-center justify-center gap-2 text-sm">
                                <svg class="icon-xs" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg>
                                Modifica
                            </button>
                            <button data-action="delete" data-id="${recipe.id}" class="btn-recipe w-full sm:w-auto bg-gradient-to-r from-rose-500 to-rose-600 text-white px-5 py-3 rounded-xl font-semibold hover:from-rose-600 hover:to-rose-700 shadow-md flex items-center justify-center gap-2 text-sm">
                                <svg class="icon-xs" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                Elimina
                            </button>
                        </div>
                    `;
                    this.ui.recipeListContainer.appendChild(recipeEl);
                });
            },

            handleRecipeListClick(e) {
                const viewBtn = e.target.closest('[data-action="view"]');
                const editBtn = e.target.closest('[data-action="edit"]');
                const deleteBtn = e.target.closest('[data-action="delete"]');
                const tagBtn = e.target.closest('.tag-btn');

                if (viewBtn) {
                    this.renderRecipeView(viewBtn.dataset.id);
                } else if (editBtn) {
                    this.renderRecipeForm(editBtn.dataset.id);
                } else if (deleteBtn) {
                    this.deleteRecipe(deleteBtn.dataset.id, deleteBtn);
                } else if (tagBtn) {
                    this.filterByTag(tagBtn.dataset.tag);
                }
            },
            
            deleteRecipe(id, button) {
                this.recipes = this.recipes.filter(r => r.id !== id);
                this.saveRecipesToLocal();
                this.renderRecipeList();
                this.showNotification('Ricetta eliminata');
            },
            
            handleSearch(e) {
                this.searchTerm = e.target.value.toLowerCase();
                this.renderRecipeList();
            },
            
            filterByTag(tag) {
                this.activeTag = tag;
                this.renderRecipeList();
            },

            resetFilters() {
                this.activeTag = null;
                this.searchTerm = '';
                this.ui.searchInput.value = '';
                this.renderRecipeList();
            },

            renderRecipeView(id) {
                const recipe = this.recipes.find(r => r.id === id);
                if (!recipe) return;

                this.currentRecipeId = id;
                document.getElementById('recipe-view-name').textContent = recipe.name;
                document.getElementById('recipe-view-servings-original').textContent = recipe.servings;
                document.getElementById('recipe-servings-input').value = recipe.servings;
                
                const img = document.getElementById('recipe-view-image');
                img.src = recipe.image || this.defaultImg;
                img.onerror = () => { img.src = this.defaultImg; };
                
                document.getElementById('recipe-view-procedure').textContent = recipe.procedure;
                this.renderIngredients(recipe.ingredients, 1);
                this.showView('view');
            },

            renderIngredients(ingredients, scaleFactor) {
                const container = document.getElementById('recipe-view-ingredients');
                container.innerHTML = '';
                
                if (!ingredients) return;

                ingredients.forEach(ing => {
                    let amountText;
                    if (ing.unit === 'qb') {
                        amountText = 'q.b.';
                    } else {
                        const amount = parseFloat(ing.amount) * scaleFactor;
                        amountText = (amount < 10 ? amount.toFixed(1) : amount.toFixed(0)) + ` ${ing.unit}`;
                    }
                    
                    const li = document.createElement('li');
                    li.className = "flex items-start gap-3 p-2 rounded-lg hover:bg-amber-100/50 transition-colors";
                    li.innerHTML = `
                        <span class="text-amber-600 text-lg mt-0.5">‚Ä¢</span>
                        <div class="flex-1">
                            <span class="font-semibold text-amber-900">${ing.name}</span>
                            <span class="text-amber-800/80 ml-2">${amountText}</span>
                        </div>
                    `;
                    container.appendChild(li);
                });
            },
            
            parseServings(servingsStr) {
                if (!servingsStr) return { value: 0, type: 'unknown' };
                const str = servingsStr.toLowerCase();
                const num = parseFloat(str.replace(',', '.'));
                
                if (isNaN(num)) return { value: 0, type: 'unknown' };

                let type;
                if (str.includes('teglia') || str.includes('cm')) {
                    type = 'teglia';
                } else if (str.includes('porzion')) {
                    type = 'porzioni';
                } else {
                    type = 'porzioni';
                }
                return { value: num, type: type };
            },

            handleScaleRecipe(button) {
                this.showButtonFeedback(button, 'Calcolo...');
                const recipe = this.recipes.find(r => r.id === this.currentRecipeId);
                const original = this.parseServings(recipe.servings);
                const targetStr = document.getElementById('recipe-servings-input').value;
                const target = this.parseServings(targetStr);
                
                let scaleFactor = 1;

                if (original.type === 'unknown' || target.type === 'unknown' || original.value === 0) {
                    this.showNotification('Dati originali non validi per il calcolo', true);
                    this.showButtonFeedback(button, 'Errore!', 2000, true);
                    return;
                }
                
                if (original.type !== target.type) {
                    this.showNotification('Non √® possibile convertire teglie in porzioni', true);
                    this.showButtonFeedback(button, 'Errore!', 2000, true);
                    return;
                }

                if (original.type === 'porzioni') {
                    scaleFactor = target.value / original.value;
                } else if (original.type === 'teglia') {
                    scaleFactor = (target.value * target.value) / (original.value * original.value);
                }
                
                this.renderIngredients(recipe.ingredients, scaleFactor);
                this.showButtonFeedback(button, 'Fatto!', 1500, true);
            },
            
            handlePrintView(button) {
                document.body.classList.toggle('print-mode');
                if (document.body.classList.contains('print-mode')) {
                    button.innerHTML = `
                        <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                        <span>Mostra Controlli</span>`;
                } else {
                    button.innerHTML = `
                        <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                        <span>Vista Pulita</span>`;
                }
            },

            renderRecipeForm(id) {
                const form = document.getElementById('recipe-form');
                form.reset();
                document.getElementById('ingredients-list').innerHTML = '';
                
                if (id) {
                    const recipe = this.recipes.find(r => r.id === id);
                    document.getElementById('form-title').innerHTML = '<span>‚úèÔ∏è</span><span>Modifica Ricetta</span>';
                    document.getElementById('recipe-id').value = recipe.id;
                    document.getElementById('recipe-name').value = recipe.name;
                    document.getElementById('recipe-servings').value = recipe.servings;
                    document.getElementById('recipe-image').value = recipe.image || '';
                    document.getElementById('recipe-procedure').value = recipe.procedure;
                    document.getElementById('recipe-tags').value = recipe.tags || '';
                    
                    if (recipe.ingredients) {
                        recipe.ingredients.forEach(ing => this.addIngredientRow(ing));
                    }
                } else {
                    document.getElementById('form-title').innerHTML = '<span>üìù</span><span>Nuova Ricetta</span>';
                    document.getElementById('recipe-id').value = '';
                    document.getElementById('recipe-servings').value = '20 cm';
                    this.addIngredientRow();
                }
                this.showView('form');
            },

            addIngredientRow(ingredient = { name: '', amount: '', unit: 'g' }) {
                const list = document.getElementById('ingredients-list');
                const row = document.createElement('div');
                row.className = 'ingredient-row flex flex-col sm:flex-row gap-2 items-center bg-white p-3 rounded-lg border-2 border-amber-200/50';
                
                row.innerHTML = `
                    <input type="text" class="ing-name flex-grow w-full border-2 border-amber-200 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="Nome ingrediente" value="${ingredient.name}" required>
                    <div class="flex-shrink-0 flex gap-2 w-full sm:w-auto">
                        <select class="unit-select w-20 border-2 border-amber-200 rounded-lg px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-amber-500" data-unit="${ingredient.unit}">
                            <option value="g" ${ingredient.unit === 'g' ? 'selected' : ''}>g</option>
                            <option value="qb" ${ingredient.unit === 'qb' ? 'selected' : ''}>q.b.</option>
                        </select>
                        <input type="number" class="amount-input w-24 border-2 border-amber-200 rounded-lg px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="Peso" value="${ingredient.amount}">
                        <button type="button" class="remove-ingredient-btn bg-gradient-to-r from-rose-500 to-rose-600 text-white p-2.5 rounded-lg hover:from-rose-600 hover:to-rose-700 shadow-sm">
                            <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
                list.appendChild(row);
                
                const select = row.querySelector('.unit-select');
                this.toggleAmountInput(select);
            },
            
            handleIngredientFormClick(e) {
                if (e.target.closest('.remove-ingredient-btn')) {
                    e.target.closest('.ingredient-row').remove();
                }
                if (e.target.classList.contains('unit-select')) {
                    this.toggleAmountInput(e.target);
                }
            },
            
            toggleAmountInput(select) {
                const row = select.closest('.ingredient-row');
                const amountInput = row.querySelector('.amount-input');
                if (select.value === 'qb') {
                    amountInput.style.visibility = 'hidden';
                    amountInput.value = '';
                } else {
                    amountInput.style.visibility = 'visible';
                }
                select.dataset.unit = select.value;
            },

            handleFormSubmit(e) {
                e.preventDefault();
                const button = document.getElementById('save-form-btn');
                this.showButtonFeedback(button, 'üíæ Salvataggio...');
                
                const id = document.getElementById('recipe-id').value;
                const ingredients = [];
                document.querySelectorAll('#ingredients-list .ingredient-row').forEach(row => {
                    const name = row.querySelector('.ing-name').value.trim();
                    const unit = row.querySelector('.unit-select').value;
                    const amount = row.querySelector('.amount-input').value;
                    
                    if (name) {
                        ingredients.push({
                            name: name,
                            amount: unit === 'qb' ? '' : amount,
                            unit: unit
                        });
                    }
                });

                const recipe = {
                    id: id || Date.now().toString(),
                    name: document.getElementById('recipe-name').value.trim(),
                    servings: document.getElementById('recipe-servings').value.trim() || '20 cm',
                    image: document.getElementById('recipe-image').value.trim(),
                    procedure: document.getElementById('recipe-procedure').value.trim(),
                    tags: document.getElementById('recipe-tags').value.trim(),
                    ingredients: ingredients
                };

                if (id) {
                    const index = this.recipes.findIndex(r => r.id === id);
                    this.recipes[index] = recipe;
                } else {
                    this.recipes.unshift(recipe);
                }

                this.saveRecipesToLocal();
                this.renderRecipeList();
                this.showView('list');
                this.showNotification(`Ricetta "${recipe.name}" salvata!`);
            },

            showNotification(message, isError = false) {
                const el = this.ui.notification;
                el.textContent = message;
                el.className = isError 
                    ? 'fixed bottom-6 right-6 bg-gradient-to-r from-rose-900 to-rose-800 text-white px-6 py-4 rounded-xl shadow-2xl border-2 border-rose-700 font-medium'
                    : 'fixed bottom-6 right-6 bg-gradient-to-r from-amber-900 to-amber-800 text-white px-6 py-4 rounded-xl shadow-2xl border-2 border-amber-700 font-medium';
                
                el.classList.add('show');
                setTimeout(() => {
                    el.classList.remove('show');
                }, 3000);
            },

            showButtonFeedback(button, message, duration = 1500, forceOriginal = false) {
                if (!button.dataset.originalText && !forceOriginal) {
                    button.dataset.originalText = button.innerHTML;
                }
                button.innerHTML = message;
                button.disabled = true;

                setTimeout(() => {
                    if (button.dataset.originalText) {
                        button.innerHTML = button.dataset.originalText;
                        delete button.dataset.originalText;
                    }
                    button.disabled = false;
                }, duration);
            }
        };

        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
